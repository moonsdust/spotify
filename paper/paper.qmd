---
title: "Characteristics of Top Songs Has Changed from Pandemic Brain"
subtitle: "An analysis of songs on Billboard's Year-End Hot 100 list (2014 to 2023)"
author: Emily Su
thanks: "Code and data are available at: https://github.com/moonsdust/top-songs."
date: today
date-format: long
abstract: "Music often reflects the current climate of society and there is a growing interest in how hit songs as seen on Billboard's Year-End Hot 100 singles has changed after the COVID-19 pandemic. This paper looks at music characteristics such as tempo, song duration, loudness, and modality of songs from Billboard's Year-End Hot 100 singles list from 2014 to 2023 to reveal patterns and relationships to explain the difference between top songs before 2020 and 2020 onwards. The results show that hit songs from 2020 onwards had become on average shorter, quieter, but slightly faster with the melody of songs being in a major key. These results can support the evaluation of the emotional state of different populations and improve treatments such as music therapy, however further investigation is needed on the influence of lyrics on different music characteristics."
format:
  pdf:
    toc: true
number-sections: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false

library(tidyverse)
library(arrow)
library(ggcorrplot)
library(ggplot2)
library(knitr)
library(modelsummary)
library(rstanarm)

# Packages related to causal model created
library(DiagrammeR)
library(rsvg)
library(magrittr)
library(DiagrammeRsvg)
library(png)

# Read in data 
playlist_analysis_data <- read_parquet("../data/analysis_data/playlists_analysis_data.parquet")

hit_song_model_results <- readRDS("../models/hit_song_model.rds")
  
```


# Introduction

During the COVID-19 pandemic, viral songs on social media sites such as TikTok were met with thousands of listens on streaming platforms such as Spotify and at times go onto being on lists like the Billboard Year-End Hot 100. These songs often accompany thousands of short clips of people talking about their lives, challenges, etc. Ghaffari et al noted that other studies have found that people used music as a way to cope and regulate their thoughts and emotions during the pandemic and the lockdowns that came with it [@citecoping]. We can see this translated through the short-form videos where users don't talk and instead have the song play out to convey how they are feeling or thinking. Ghaffari et al's findings are similar to how music therapy works. As defined by the Canadian Association of Music Therapists, music therapy is the use of music to support an individual's health, social development, and well-being and some of the techniques used include listening to music [@citemusictherapy]. Hurwitz and Krumhansl conducted a study into how people's listening habits throughout the pandemic and they found that the songs they listened to often were linked to an emotion such as sadness and/or invoking memories from the past [@citeshiftingniches]. However, this raises the following question, which we explored in our analysis: how are top songs prior to 2020 or the start of the pandemic different from the top songs during and after 2020?

In this paper, to investigate patterns and trends in music, we analyzed data from the Billboard Year-End Hot 100 singles list from 2014 to 2023 on music characteristics such as its modality (major or minor key), track duration, loudness, and tempo. Our estimand is the song characteristics from the Billboard Year-End Hot 100 singles such as its modality (major or minor), track duration, loudness, and tempo if a song was created before 2020 or during and after 2020. The list allowed us to gauge how preference in music characteristics has changed overall during and after the pandemic. Current studies give us a sense of how currently people are feeling based on surveys done. However, there is currently a lack of understanding and focus on the difference in musical characteristics of popular songs with the general population before the pandemic and during and after it. In our findings, our data showed that songs in a major key made up the majority of top songs before, during, and after 2020 and top songs were on average quieter, shorter, and had slightly faster tempos during and after 2020. [TODO: ADD RESULTS FROM MODEL]. Music can reflect the climate of society and understanding trends in music characteristics of hit songs can help provide insight on the overall feelings of different populations during and after the pandemic as well as before it. This can aid in improving treatments such as music therapy.

In the rest of this paper, the data section (@sec-data) will cover the dataset used, how it was obtained, define the variables of interest that are used by our tables and graphs, and briefly explain the data cleaning process. The model section (@sec-model) will explain our proposed causal model, which would explain potential relationships in our data, the setup of our model to understand these relationships, and justification for our model. In the results section (@sec-results), we will reveal tables and graphs made on our datasets, explain what they show, and show our results from our model. In the discussion section (@sec-discussion), we will connect back to the real world and explain what the results could mean, the implications of our results, potential areas of improvement for the paper, and suggestions for future works. Finally, the appendix section (@sec-appendix) will extra tables and graphs from our results as well, as additional information about the model, and a link to a Shiny application featuring an interactive graph of some of the results. 


# Data {#sec-data}
[To Do]

## Variables of Interest

## Data Source and Measurements
```{r}
#| label: tbl-dataset-preview
#| tbl-cap: Preview of dataset on Billboard Year-End Hot 100 singles from 2014 to 2023 provided by Spotify
#| echo: false
#| warning: false
#| message: false

playlist_analysis_data |> 
  select(hit_year, track_duration_ms, tempo, loudness, mode_name, key_mode, period) |>
  head() |>
  kable()
```
Not seen in @tbl-dataset-preview, before_pandemic, major, and minor are numerical versions of the mode_name and period columns. 

## Methodology
The dataset used in this paper was retrieved, simulated, cleaned, analyzed, and tested using the R programming language [@citeR], tidyverse [@citetidyverse], knitr [@citeknitr], janitor [@citejanitor], dplyr [@citedplyr], ggplot2 [@citeggplot2], spotifyr [@citespotifyr], usethis [@citeusethis], arrow [@citearrow], ggcorrplot [@citeggcorrplot], testthat [@citetestthat]. The packages that were used for the model-related sections or used for the model itself are DiagrammeR [@citeDiagrammeR], rsvg [@citersvg], magrittr [@citemagrittr], DiagrammeRsvg [@citeDiagrammeRsvg], png [@citepng], rstanarm [@citerstanarm], and modelsummary [@citemodelsummary]. 

# Model {#sec-model}
From our analysis of the data, we observed that there were trends between a song's duration, loudness, tempo, and modality for top songs prior 2020 and 2020 onwards. We are interested in investigating if a song is likely to be a top song prior to 2020 or not based on what we know about the duration, loudness, tempo, and modality of a top song. We will do this by creating a model. 

## Model set-up
In order to predict a top song was a hit prior to 2020, we will make the assumption that there is a relationship between the outcome variable, if the song is a top song prior to 2020 and our variables of interests: duration, loudness, tempo, and modality. Our variables of interests will be the predictor variables for the model. We will define our model as a logistic regression model with a Bayesian approach as follows:
\begin{align*} 
y_i|\pi_i &\sim \mbox{Bern}(\pi_i) \\
\mbox{logit}(\pi_i) &= \beta_0 + \beta_1 \times \mbox{duration}_i + \beta_2 \times \mbox{loudness}_i + \beta_3 \times \mbox{tempo}_i + \beta_4 \times \mbox{modality}_i\\
\beta_0 &\sim \mbox{Normal}(0, 2.5) \\
\beta_1 &\sim \mbox{Normal}(0, 2.5) \\
\beta_2 &\sim \mbox{Normal}(0, 2.5) \\
\beta_3 &\sim \mbox{Normal}(0, 2.5) \\
\beta_4 &\sim \mbox{Normal}(0, 2.5) \\
\end{align*}

We define $y_i$ to be a top song, which if it is 1 represents a top song prior to 2020 and 0 if it is a top song from 2020 onwards. $\pi_i$ is the probability that a top song $i$ is a top song prior to 2020. Let $\mbox{duration}_i$ be the duration of the top song in milliseconds (ms) and $\mbox{loudness}_i$ to be the mean loudness of a top song in decibels (dB). Set $\mbox{tempo}_i$ to be the mean beats per minutes (BPM) of a top song and $\mbox{modality}_i$ to be the modality of the top song, where 1 means the melody of the song is in a minor key and 0 if it is in a major key. 

We ran the model using the rstanarm package (@citerstanarm) with the default priors from the package. Diagnostics related to the model such as a trace plot, Rhat plot, and posterior predictive check can be found at @sec-appendix.

### Model justification
A logistic regression model was chosen because our outcome variable, if the song is a top song prior to 2020, is a binary outcome. However, alternative models were considered such as a multiple linear regression model since the model has multiple predictor variables. Other regressions models like negative binomial regressions were also considered but they were not chosen since we are not deleting with discrete counts for the outcome. Our logistic regression model describes the following causal relationship (@fig-causal-model) where song characteristics predicts whatever a hit song was made prior to 2020, excluding a confounder, lyrics. The assumption we make is that there is a relationship between song characteristics and a top song being a hit prior to 2020. In @fig-causal-model, the reason lyrics is a confounder is because lyrics can affect not only if the song was a hit prior to 2020 but also song characteristics. However, we are unable to observe the effects of lyrics directly with our data.
```{r}
#| label: fig-causal-model
#| fig-cap: Causal relationship between song characteristics and hit song (before 2020 or during and after 2020)
#| echo: false
#| warning: false
#| message: false

# Referenced https://www.erikigelstrom.com/articles/causal-graphs-in-r-with-diagrammer/
# https://stackoverflow.com/questions/42737645/how-to-export-images-of-diagrammer-in-r
causal_model <- "digraph {
  graph []
  # Nodes 
  node [shape = plaintext]
    A [label = 'Hit song before 2020 or during and after 2020']
    B [label = 'Modality']
    C [label = 'Loudness']
    D [label = 'Duration']
    E [label = 'Tempo']
    F [label = 'Lyrics (Confounder)']
  # Edges for non-confounding variables
  edge []
    B->A
    C->A
    D->A
    E->A
{ rank = same; }
  # Edges for confounding variable
  edge [style = dashed]
    F -> B
    F -> C
    F -> D
    F -> E
    F -> A
}"

exporting_image <- grViz(causal_model) |>
  export_svg() |>
  charToRaw() |>
  rsvg_png("../other/sketches/graph_2_casual_model.png", width = 1000)

# NOTE: Had to save diagram and read it in as a image since grViz can be only render in HTML and 
# not in PDFs 
# Referenced https://stackoverflow.com/questions/23861000/displaying-images-in-r-in-version-3-1-0
the_image <- readPNG("../other/sketches/graph_2_casual_model.png")
plot.new()
rasterImage(the_image, 0, 0, 0.8, 1.13)
```

# Results {#sec-results}
[To Finish]

## Difference in song characteristics before 2020 (the pandemic) and during and after 2020 (the pandemic) of songs from the Billboard Year-End Hot 100 singles 

### Scale and Modality

```{r}
#| label: fig-mode-bar
#| fig-cap: Proportion of songs whose modality is in a major or minor key before 2020 versus during and after 2020
#| echo: false
#| warning: false
#| message: false

proportion_of_each_mode <- 
  playlist_analysis_data |>
  # Group by if song was a hit before or during and after the pandemic
  group_by(period) |>
  # Count each scale
  count(mode_name) |>
  # rename count column to num_of_key_mode
  rename(
    'num_of_mode_name' = n
  ) |>
  mutate( 
    proportion_mode_name =  round(num_of_mode_name / sum(num_of_mode_name), 2) 
  ) 


proportion_of_each_mode |> 
  ggplot(mapping = aes(x = mode_name, y = proportion_mode_name)) +
  facet_wrap(facets = vars(period), dir = "v") + 
  geom_bar(stat = "identity", binwidth = 3) +
  theme_minimal() +
  labs(x = "Modality",
       y = "Proportion") + 
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
#| label: tbl-mode-table
#| tbl-cap: Proportion of songs whose modality is in a major or minor key before 2020 versus during and after 2020
#| echo: false
#| warning: false
#| message: false

proportion_of_each_mode |> 
  rename( 
    "Period" = period,
    "Modality" = mode_name,
    "Count of each mode" = num_of_mode_name,
    "Proportion of each mode" = proportion_mode_name
    ) |>
  kable()
```

```{r}
#| label: fig-key-mode-bar
#| fig-cap: Proportion of songs in different scales before 2020 versus during and after 2020
#| echo: false
#| warning: false
#| message: false

proportion_of_each_key_mode <- 
  playlist_analysis_data |>
  # Group by if song was a hit before or during and after the pandemic
  group_by(period) |>
  # Count each scale
  count(key_mode) |>
  # rename count column to num_of_key_mode
  rename(
    'num_of_key_mode' = n
  ) |>
  mutate( 
    proportion_key_mode =  round(num_of_key_mode / sum(num_of_key_mode), 2)
  ) 

proportion_of_each_key_mode |> 
  ggplot(mapping = aes(x = key_mode, y = proportion_key_mode)) +
  facet_wrap(facets = vars(period), dir = "v") + 
  geom_bar(stat="identity", binwidth = 3) +
  theme_minimal() +
  labs(x = "Scale",
       y = "Proportion") + 
  theme(axis.text.x = element_text(angle = 90))
```

\newpage 

### Track Duration

```{r}
#| label: fig-track-duration-scatterplot
#| fig-cap: Relationship between the hit year and track duration of a song 
#| echo: false
#| warning: false
#| message: false

playlist_analysis_data |> 
  ggplot(aes(x = hit_year, y = track_duration_ms)) +
  geom_smooth() +
  geom_jitter() +  # So we can see all points
  geom_point(alpha = 0.3) +
  theme_minimal() +
  labs(x = "Hit year",
       y = "Duration of song (in ms)")
```

```{r}
#| label: fig-track-duration-hist
#| fig-cap: Distribution of track duration (in ms) before 2020 versus during and after 2020  
#| echo: false
#| warning: false
#| message: false
#| 
playlist_analysis_data |> 
  ggplot(mapping = aes(x = track_duration_ms)) +
  facet_wrap(facets = vars(period), dir = "v") + 
  geom_histogram(binwidth = 7000) +
  theme_minimal() +
  labs(x = "Duration of song (in ms)",
       y = "Count")
```

```{r}
#| label: fig-track-duration-boxplot
#| fig-cap: Track duration (in ms) before 2020 versus during and after 2020  
#| echo: false
#| warning: false
#| message: false

playlist_analysis_data |> 
  ggplot(mapping = aes(x = track_duration_ms)) +
  facet_wrap(facets = vars(period), dir = "v") + 
  geom_boxplot() +
  theme_minimal() +
  labs(x = "Duration of song (in ms)",
       y = "Count")
```

```{r}
#| label: tbl-track-duration-stats-before
#| tbl-cap: Minimum, quartiles, median, and maximum of track duration (in ms) before 2020
#| echo: false
#| warning: false
#| message: false

playlist_analysis_data |> 
  # Filter for "Before Pandemic"
  filter(period == "Before Pandemic") |>
  # Choose track_duration_ms
  select(track_duration_ms) |>
  # Rename columns
  rename (
    "Duration of song (in ms)"= track_duration_ms
  ) |>
  summary() |>
  kable()
```

```{r}
#| label: tbl-track-duration-stats-during-after
#| tbl-cap: Minimum, quartiles, median, and maximum of track duration (in ms) during and after 2020
#| echo: false
#| warning: false
#| message: false

playlist_analysis_data |> 
  # Filter for During and After Pandemic
  filter(period == "During and After Pandemic") |>
  # Choose track_duration_ms
  select(track_duration_ms) |>
  # Rename columns
  rename (
    "Duration of song (in ms)"= track_duration_ms
  ) |>
  summary() |>
  kable()
```

\newpage

### Loudness

```{r}
#| label: fig-loudness-scatterplot
#| fig-cap: Relationship between the hit year and loudness of a song 
#| echo: false
#| warning: false
#| message: false

playlist_analysis_data |> 
  ggplot(aes(x = hit_year, y = loudness)) +
  geom_smooth() +
  geom_jitter() +  # So we can see all points
  geom_point(alpha = 0.3) +
  theme_minimal() +
  labs(x = "Hit year",
       y = "Loudness of song (in dB)")
```
```{r}
#| label: fig-loudness-hist
#| fig-cap: Distribution of loudness (in dB) before 2020 versus during and after 2020  
#| echo: false
#| warning: false
#| message: false
#| 
playlist_analysis_data |> 
  ggplot(mapping = aes(x = loudness)) +
  facet_wrap(facets = vars(period), dir = "v") + 
  geom_histogram(binwidth = 0.3) +
  theme_minimal() +
  labs(x = "Loudness of song (in dB)",
       y = "Count")
```

```{r}
#| label: tbl-loudness-stats-before
#| tbl-cap: Minimum, quartiles, median, and maximum of loudness of song (in dB) before 2020
#| echo: false
#| warning: false
#| message: false

playlist_analysis_data |> 
  # Filter for "Before Pandemic"
  filter(period == "Before Pandemic") |>
  # Choose loudness
  select(loudness) |>
  # Rename columns
  rename (
    "Loudness of song (in dB)"= loudness
  ) |>
  summary() |>
  kable()
```

```{r}
#| label: tbl-loudness-stats-during-after
#| tbl-cap: Minimum, quartiles, median, and maximum of loudness of song (in dB) during and after 2020
#| echo: false
#| warning: false
#| message: false

playlist_analysis_data |> 
  # Filter for "During and After Pandemic"
  filter(period == "During and After Pandemic") |>
  # Choose loudness
  select(loudness) |>
  # Rename columns
  rename (
    "Loudness of song (in dB)"= loudness
  ) |>
  summary() |>
  kable()
```
\newpage

### Tempo

```{r}
#| label: fig-tempo-scatterplot
#| fig-cap: Relationship between the hit year and tempo of a song 
#| echo: false
#| warning: false
#| message: false

playlist_analysis_data |> 
  ggplot(aes(x = hit_year, y = tempo)) +
  geom_smooth() +
  geom_jitter() +  # So we can see all points
  geom_point(alpha = 0.3) +
  theme_minimal() +
  labs(x = "Hit year",
       y = "Tempo of song (BPM)")
```

```{r}
#| label: fig-tempo-hist
#| fig-cap: Distribution of tempo (BPM) before 2020 versus during and after 2020  
#| echo: false
#| warning: false
#| message: false

playlist_analysis_data |> 
  ggplot(mapping = aes(x = tempo)) +
  facet_wrap(facets = vars(period), dir = "v") + 
  geom_histogram(binwidth = 3) +
  theme_minimal() +
  labs(x = "Tempo of song (BPM)",
       y = "Count")
```

```{r}
#| label: tbl-tempo-stats-before
#| tbl-cap: Minimum, quartiles, median, and maximum of tempo of a song (BPM) before 2020
#| echo: false
#| warning: false
#| message: false

playlist_analysis_data |> 
  # Filter for "Before Pandemic"
  filter(period == "Before Pandemic") |>
  # Choose tempo
  select(tempo) |>
  # Rename columns
  rename (
    "Tempo of song (BPM)"= tempo
  ) |>
  summary() |>
  kable()
```

```{r}
#| label: tbl-tempo-stats-during-after
#| tbl-cap: Minimum, quartiles, median, and maximum of tempo of a song (BPM) during and after 2020
#| echo: false
#| warning: false
#| message: false

playlist_analysis_data |> 
  # Filter for "During and After Pandemic"
  filter(period == "During and After Pandemic") |>
  # Choose tempo
  select(tempo) |>
  # Rename columns
  rename (
    "Tempo of song (BPM)"= tempo
  ) |>
  summary() |>
  kable()
```

\newpage


## Model Results
[To Do]

```{r}
#| label: tbl-model-result
#| tbl-cap: How likely a hit song is a hit before 2020 / the pandemic based on its tempo, song duration, loudness, and modality
#| echo: false
#| warning: false
#| message: false

modelsummary(
  list("A hit song before 2020" = hit_song_model_results),
  statistic = "mad"
)
```
```{r}
#| label: fig-model-result-ci
#| fig-cap: The credible intervals for predictors of a hit song before 2020
#| echo: false
#| warning: false
#| message: false

modelplot(hit_song_model_results, conf_level = 0.9) +
  labs(x = "90 per cent credibility interval")
```
\newpage

# Discussion {#sec-discussion}

[To Do]

\newpage

\appendix

# Appendix {#sec-appendix}

## Additional Figures and Tables 

```{r}
#| label: fig-correlation-matrix
#| fig-cap: Correlation between numerical characteristics of songs from Billboard Year-End Hot 100 single and if song was a hit before 2020/the pandemic
#| echo: false
#| warning: false
#| message: false

# Referenced https://rpubs.com/Alema/1000474
numeric_playlist_analysis_data <- 
  playlist_analysis_data |>
  select(-c(mode_name, key_mode, period, hit_year))

ggcorrplot(cor(numeric_playlist_analysis_data), 
           hc.order = TRUE,
           outline.color = "white", lab = TRUE, legend.title = "Correlation") 
```

\newpage

## Posterior predictive check for model {#sec-model-details-posterior-check}
```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-posteriorpredictive
#| fig-cap: "How the data impacts how the model fits"
#| fig-subcap: ["Posterior prediction check for the model"]
#| layout-ncol: 1

rstanarm::pp_check(hit_song_model_results) +
  theme_classic() +
  theme(legend.position = "bottom")
```
\newpage

## Diagnostics for model  {#sec-model-details-diagnostics}
```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-convergencecheck
#| fig-cap: "Checking the convergence of the MCMC algorithm for hit song model"
#| fig-subcap: ["Trace plot for model", "Rhat plot for model"]
#| layout-ncol: 2

plot(hit_song_model_results, "trace")

plot(hit_song_model_results, "rhat") + theme_minimal()
```



# References


